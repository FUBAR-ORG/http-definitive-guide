# 프록시

- 웹 프록시 서버는 중개자.
- 프록시는 클라이언트와 서버 사이에 위치하여 그들 사이의 `HTTP` 메세지를 정리하는 중개인처럼 동작.

## 웹 중개자

- 웹 프록시 서버는 클라이언트 입장에서 트랜잭션을 수행하는 중개인.
  - 웹 프록시가 없다면, 클라이언트는 `HTTP` 서버와 직접 이야기.
  - 웹 프록시가 있다면, 클라이언트는 자신의 입장에서 서버와 대화해주는 프록시와 이야기.
    > 프록시 서버가 제공하는 좋은 서비스를 이용하게 됨.
- `HTTP` 프록시 서버는 웹 서버이기도 하고 웹 클라이언트이기도 함.
- 프록시는 `HTTP` 클라이언트의 요청을 받게 되므로, 반드시 웹 서버처럼 요청과 커넥션을 적절히 다루고 응답을 돌려주어야 함.
- 동시에 프록시는 요청을 서버로 보내기도 하므로, 요청을 보내고 응답을 받는 올바른 `HTTP` 클라이언트처럼 동작해야 함.

> `HTTP` 프록시는 `HTTP` 클라이언트와 `HTTP` 서버 양쪽 규칙 모두를 주의 깊게 따라야 함.

### 개인 프록시와 공유 프록시

- 프록시 서버는 하나의 클라이언트가 독점적으로 사용할 수도 있고, 여러 클라이언트가 공유할 수도 있음.

#### 공용 프록시

- 여러 클라이언트가 함께 사용하는 프록시.
- 대부분의 프록시는 공용이며 공유된 프록시.
- 중앙 집중형 프록시를 관리하는 것이 비용 효율이 높고 쉬움.
- 캐시 프록시 서버와 같은 몇몇 프록시 애플리케이션은 프록시를 이용하는 사용자가 많을 수록 유리함.
  - 사용자들의 공통된 요청에서 이득을 취할 수 있기 때문.

#### 개인 프록시

- 하나의 클라이언트를 위한 프록시.
- 클라이언트 컴퓨터에서 직접 실행되는 형태로 꾸준히 사용됨.
- 브라우저의 보조 제품들은 몇몇 `ISP` 서비스와 마찬가지로 브라우저의 기능을 확장하거나 성능을 개선하거나 무료 `ISP` 서비스를 위한 광고를 운영하기 위해 작은 프록시를 사용자의 컴퓨터에서 직접 실행.

### 프록시 대 게이트웨이

- 프록시: 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결.
- 게이트웨이: 서로 다른 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결.
  - 클라이언트와 서버가 서로 다른 프로토콜로 말하더라도 서로 간의 트랜잭션을 완료할 수 있도록 해주는 프로토콜 변환기처럼 작동.
- 실질적으로 프록시와 게이트웨이의 차이점은 모호.
  - 브라우저와 서버는 다른 버전의 `HTTP`를 구현하기 때문에, 프록시는 때때로 약간의 프로토콜 변환을 하기도 함.
- 상용 프록시 서버는 `SSL` 보안 프로토콜, `SOCKS` 방화벽, `FTP` 접근 그리고 웹 기반 애플리케이션을 지원하기 위해 게이트웨이 기능을 구현.

---

## 왜 프록시를 사용하는가?

- 프록시 서버는 보안 개선, 성능 증가, 비용 절약 등 실용적이고 유용한 일을 함.
- 프록시 서버는 모든 `HTTP` 트래픽을 들여다보고 건드릴 수 있기 때문에, 부가적인 가치를 주는 여러 유용한 웹 서비스를 구현하기 위해 트래픽을 감시하고 수정 가능.

#### 어린이 필터

- 교육 사이트를 제공하면서 성인 콘텐츠를 차단하는 필터링 프록시 사용 가능.
- 부적절한 사이트의 접근 강제로 거부.

#### 문서 접근 제어자

- 많은 웹 서버들과 웹 리소스에 대한 단일한 접근 제어 전략을 구현하고 감사 추적(audit trail)을 하기 위해 사용 가능.
- 각기 다른 조직에서 관리되는 다양한 종류의 수 많은 웹 서버들에 대한 접근 제어를 수시로 갱신할 필요 없이, 중앙 프록시 서버에서 접근 제어를 설정 가능.

#### 보안 방화벽

- 보안을 강화하기 위해 프록시 서버를 사용.
- 프록시 서버는 조직 안에 들어오거나 나가는 응용 레벨 프로토콜의 흐름을 네트워크의 한 지점에서 통제.
- 바이러스를 제거하는 웹이나 이메일 프록시가 사용할 수 있는, 트래픽을 세심히 살펴볼 수 있는 후크(`hook`)를 제공.

#### 웹 캐시

- 프록시 캐시는 인기 있는 문서의 로컬 사본을 관리하고 해당 문서에 대한 요청이 오면 빠르게 제공하여, 느리고 비싼 인터넷 커뮤니케이션을 줄임.

#### 대리 프록시

- 어떤 프록시들은 웹 서버인 것처럼 위장.
- 대리 혹은 리버스 프록시라고 불리는 이들은 진짜 웹 서버의 요청을 받지만, 웹 서버와는 달리 요청받은 콘텐츠의 위치를 찾아내기 위해 다른 서버와 커뮤니케이션을 시작.
- 공용 콘텐츠에 대한 느린 웹 서버의 성능을 개선하기 위해 사용 가능.
  - 이런 용도의 대리 프록시를 흔히 서버 가속기라고 부름.
- 콘텐츠 라우팅 기능과 결합되어 주문형 복제 콘텐츠의 분산 네트워크를 만들기 위해 사용 가능.

#### 콘텐츠 라우터

- 인터넷 트래픽 조건과 콘텐츠의 종류에 따라 요청을 특정 웹 서버로 유도하는 콘텐츠 라우터로 동작 가능.
- 콘텐츠 라우터는 또한 사용자들에게 제공할 여러 서비스를 구현하는데 사용 가능.
  - 높은 성능을 위한 돈을 지불했다면, 요청을 가까운 복제 캐시로 전달.
  - 필터링 서비스에 가입했다면, `HTTP` 요청이 필터링 프록시를 통과하도록 설정.
- 많은 흥미로운 서비스가 맞춤형 콘텐츠 라우팅 프록시를 이용해서 구성 가능.

#### 트랜스코더

- 콘텐츠를 클라이언트에게 전달하기 전에 본문 포맷을 수정 가능.
- 데이터의 표현 방식을 자연스럽게 변환하는 것을 "트랜스코딩"이라고 부름.
- 트랜스코딩 프록시는 자신을 거쳐가는 파일(`GIF` 이미지를 `JPG` 이미지로, 텍스트 파일을 압축하는 등)의 변환 및 수정 가능.
  - 문서를 외국어 문서로 변환하는 것 또한 가능.

#### 익명화 프록시(`Anonymizer`)

- `HTTP` 메세지에서 신원을 식별할 수 있는 특성들(클라이언트 `IP` 주소, `From` 헤더, `Referer` 헤더, 쿠키, `URI` 세션 아이디 등)을 적극적으로 제거함으로써 개인 정보 보호와 익명성 보장에 기여.
  - `User-Agent` 헤더에서 사용자의 컴퓨터와 `OS`의 종류를 제거.
  - 사용자의 이메일 주소를 보호하기 위해 `From` 헤더 제거.
  - 어떤 사이트를 거쳐서 방문했는지 알기 어렵게 하기 위해 `Referer` 헤더 제거.
  - 프로필과 신원 정보를 없애기 위해 `Cookie` 헤더 제거.

---

## 프록시는 어디에 있는가?

### 프록시 서버 배치

- 어떻게 사용할지에 따라서 프록시는 어디든 배치 가능.

#### 출구(`Egress`) 프록시

- 로컬 네트워크와 더 큰 인터넷 사이를 오가는 트래픽을 제어하기 위해 프록시를 로컬 네트워크 출구에 위치 가능.
- 방화벽 제공 및 인터넷 요금 절약과 트래픽 성능 개선 등의 이유를 위해 사용 가능.
  - 부적절한 콘텐츠를 브라우징하는 것을 막기 위해 필터링 출구 프록시 사용 가능.

#### 접근(입구) 프록시

- 모든 요청을 종합적으로 처리하기 위해 프록시는 `ISP` 접근 지점에 위치 가능.
- `ISP`는 사용자들의 다운로드 속도를 개선하고 인터넷 대역폭 비용을 줄이기 위해 캐시 프록시를 사용해 많이 찾는 문서들의 사본을 저장.

#### 대리 프록시(리버스 프록시)

- 네트워크의 가장 끝에 있는 웹 서버들의 바로 앞에 위치하여 웹 서버로 향하는 모든 요청을 처리하고 필요할 때만 웹 서버에 자원을 요청 가능.
- 웹 서버에 보안 기능을 추가하거나 빠른 웹 서버 캐시를 느린 웹 서버의 앞에 놓아 성능 개선 가능.
- 일반적으로 웹 서버의 이름과 `IP` 주소로 스스로를 가장하기 때문에, 모든 요청은 서버가 아닌 이 프록시로 가게 됨.

#### 네트워크 교환 프록시

- 캐시를 이용해 인터넷 교차로의 혼잡을 완화하고 트래픽 흐름을 감시하기 위해, 충분한 처리 능력을 갖춘 프록시가 네트워크 사이의 인터넷 피어링 교환 지점에 위치 가능.

### 프록시 계층

- 프록시들은 프록시 계층이라고 불리는 연쇄를 구성 가능.
- 프록시 계층에서, 메세지는 최종적으로 원 서버에 도착할 때까지 프록시와 프록시를 거쳐서 이동.
- 프록시 계층에서 프록시 서버들은 `부모-자식` 관계를 가짐.
  - 다음 번 인바운드 프록시(서버 가까운 쪽): 부모
  - 다음 번 아웃바운드 프록시(클라이언트 가까운 쪽): 자식

#### 프록시 계층 콘텐츠 라우팅

- 프록시 계층이 반드시 정적인 것은 아님.
- 프록시 서버는 여러 가지 판단 근거에 의해 메세지를 다양하고 유동적인 프록시 서버와 원 서버들의 집합에게 보낼 수 있음.
  - 요청된 객체가 콘텐츠 분산을 위해 돈을 지불한 웹 서버에 속한 경우, 프록시는 요청을 가까운 캐시 서버에게 보내 캐시된 객체를 반환하거나, 그럴 수 없을 때는 서버에서 가져오게 할 수 있음.
  - 요청이 특정 종류의 이미지에 대한 것인 경우, 접근 프록시는 그 요청을 특화된 압축 프록시에게 보내어 그 프록시가 이미지를 가져와 압축하게 하여 느린 모뎀으로 접속했더라도 빠르게 클라이언트가 다운로드할 수 있게 함.
- 동적 부모 선택의 예
  - 부하 균형
    - 자식 프록시는 부하를 분산하기 위해 현재 부모들의 작업량 수준에 근거하여 부모 프록시 선택 가능.
  - 지리적 인접성에 근거한 라우팅
    - 자식 프록시는 원 서버의 지역을 담당하는 부모를 선택 가능.
  - 프로토콜/타입 라우팅
    - 자식 프록시는 `URI`에 근거하여 다른 부모나 원 서버로 라우팅 가능.
    - 어떤 특정 종류의 `URI`를 갖고 있는 요청의 경우, 특별한 프록시로 보내져 특별한 프로토콜로 처리 가능.
  - 유료 서비스 가입자를 위한 라우팅
    - 웹 서비스 운영자가 빠른 서비스를 위해 추가금을 지불했다면, 그들의 `URI`는 대형 캐시나 성능 개선을 위한 압축 엔진으로 라우팅 가능.
- 동적 부모 라우팅 로직은 제품(설정 파일, 스크립트 언어, 동적으로 실행 가능한 플러그인 등)마다 다르게 구현.

### 어떻게 프록시가 트래픽을 처리하는가

- 클라이언트 트래픽이 프록시로 가도록 만드는 방법 네 가지
  1. 클라이언트를 수정한다
     - 많은 웹 클라이언트들은 수동 혹은 자동 프록시 설정을 지원.
     - 클라이언트가 프록시를 사용하도록 설정되어 있다면, 클라이언트는 `HTTP` 요청을 의도적으로 원 서버가 아닌 프록시로 보냄.
  2. 네트워크를 수정한다
     - 클라이언트는 알지도 못하고 간섭도 할 수 없는 상태에서, 네트워크 인프라를 가로채서 웹 트래픽을 프록시로 가도록 조정하는 몇 가지 기법을 보유.
     - 이 가로챔은 일반적으로 `HTTP` 트래픽을 지켜보고 가로채어 클라이언트 모르게 트래픽을 프록시로 보내는 스위칭 장치와 라우팅 장치를 필요로 함.
       > 인터셉트 프록시라고 부름.
  3. `DNS` 이름 공간을 수정한다
     - 웹 서버 앞에 위치하는 대리 프록시는 웹 서버의 이름과 `IP` 주소를 자신이 직접 사용.
       - 따라서 모든 요청은 서버 대신 대리 프록시로 전달.
     - `DNS` 이름 테이블을 수동으로 편집하거나 사용할 적절한 프록시나 서버를 계산해주는 특별한 동적 `DNS`를 이용해서 조정 가능.
     - 몇몇 설치본에서는 실제 서버의 `IP` 주소와 이름은 변경되고 대리 프록시에게는 이전 주소와 이름이 주어짐.
  4. 웹 서버를 수정한다
     - 몇몇 웹 서버는 `HTTP` 리다이렉션 명령(응답 코드 `305`)을 클라이언트에게 돌려줌으로써 클라이언트의 요청을 프록시로 리다이렉트 하도록 설정 가능.
     - 리다이렉트를 받는 즉시 클라이언트는 프록시와의 트랜잭션을 시작.

---

## 클라이언트 프록시 설정

#### 수동 설정

#### 브라우저 기본 설정

#### 프록시 자동 설정(Proxy auto-configuration, `PAC`)

#### `WPAD` 프록시 발견

### 클라이언트 프록시 설정: 수동

### 클라이언트 프록시 설정: `PAC` 파일

### 클라이언트 프록시 설정: `WPAD`

---

## 프록시 요청의 미묘한 특징들

### 프록시 `URI`는 서버 `URI`와 다르다

### 가상 호스팅에서 일어나는 같은 문제

### 인터셉트 프록시는 부분 `URI`를 받는다

### 프록시는 프록시 요청과 서버 요청을 모두 다룰 수 있다

### 전송 중 `URI` 변경

### `URI` 클라이언트 자동 확장과 호스트 명 분성(`Hostname Resolution`)

### 프록시 없는 `URI` 분석(`URI Resolution`)

### 명시적인 프록시를 사용할 때의 `URI` 분석

### 인터셉트 프록시를 이용한 `URI` 분석

---

## 메세지 추적

### `Via` 헤더

#### `Via` 문법

#### 프로토콜 이름

#### 프로토콜 버전

#### 노드 이름

#### 노드 코멘트

#### `Via` 요청과 응답 경로

#### `Via`와 게이트웨이

#### `Server` 헤더와 `Via` 헤더

#### `Via`가 개인정보 보호와 보안에 미치는 영향

### `TRACE` 메서드

---

## 프록시 인증

---

## 프록시 상호운용성

### 지원하지 않는 헤더와 메서드 다루기

### `OPTIONS`: 어떤 기능을 지원하는지 알아보기

### `Allow` 헤더
