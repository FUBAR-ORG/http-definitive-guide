## 웹서버

    기본적으로 HTTP 요청 처리 및 응답을 제공한다.
    다양한 형태(기능, 형태, 크기)로 되어 있다.

### 역할

1. 커넥션을 맺는다.
2. 요청을 받는다.
3. 요청을 처리한다.
4. 리소스에 접근한다.
5. 응답을 만든다.
6. 응답을 보낸다.
7. 트랜잭션을 로그로 남긴다.

#

## 단계 1: 클라이언트 커넥션 수락

    지속적 커넥션을 갖고 있다면 사용하고 없으면 새 커넥션을 열 필요가 있다.

### 클라이언트 호스트 명 식별

-   역방향 DNS를 사용해서 클라이언트의 IP주소를 호스트 명으로 변환 한다.
-   호스트 명으로 구체적인 접근 제어와 로깅을 위해 사용 한다.

### ident를 통해 클라이언트 사용자 알아내기

    어떤 사용자가 HTTP 커넥션을 초기화 했는지 찾는다.

클라이언트가 ident 프로토콜을 지원한다면

1. 클라이언트는 HTTP 커넥션을 연다.
2. 서버는 identd 서버 포트를 향해 커넥션을 연다.
3. 새 커넥션(1)에 대응하는 사용자 이름을 묻는 간단한 요청을 보낸다.

#

## 단계 2: 요청 메세지 수신

1. 커넥션에 데이터가 도착하면 파싱하여 요청 메세지를 구성한다.
2. 요청줄을 파싱하여 메소드, 리소스 식별자, 버전 번호를 찾는다.
3. 메세지 헤더들을 읽는다.
4. 헤더의 끝을 의미하는 CRLF(줄바꿈)로 끝나는 빈 줄을 찾는다.
5. 요청 본문이 있다면 읽어 들인다.

#

## 단계 3: 요청 처리

    메소드, 리소스, 헤더, 본문을 얻어 처리한다.

#

## 단계 4: 리소스의 매핑과 접근

    웹 서버는 리소스 서버다.
    웹 서버가 클라이언트에 컨텐츠를 전달하려면 URL에 대응하는 알맞은 컨텐츠나
    컨텐츠 생성기를 웹 서버에서 찾아서 그 컨텐츠의 원천을 식별해야 한다.

### Docroot

    웹 서버 파일 시스템의 특정 폴더를 웹 컨텐츠를 위해 예약해 둔다.
    이 폴더는 문서 루트(Docroot)로 불린다.

예시

    // httpd.conf(설정 파일)
    DocumentRoot /usr/local/httpd/files

    요청 URL: /specials/saw-blade.gif
    => /usr/local/httpd/files/specials/saw-blade.gif(DocumentRoot + 요청 URL)

### 사용자 홈 디렉터리 docroots

    사용자들이 한 대의 웹 서버에서 각자의 개인 웹 사이트를 만들 수 있도록 해주는 것
    /~bob/index.html => bob의 개인 문서 루트

### 가상호스팅

    한 웹 서버에 여러 웹 사이트를 호스팅하고
    Host 헤더에서 얻은 IP 주소나 호스트 명을 이용해 문서 루트를 식별한다.
    하나의 웹 서버 위에서 두 개의 사이트가 완전히 분리된 컨텐츠를 갖고 호스팅 되도록 할 수 있다.

### 디렉토리 목록

    디렉토리 URL을 요청했을 때
    에러 반환, 색인 파일 반환, 탐색 후 페이지 반환할 수 있다.

### 동적 컨텐츠 리소스 매핑

    요청에 맞게 컨텐츠를 생성하는 프로그램에 URL을 매핑한다.

    웹 서버들 중 애플리케이션 서버는 웹 서버를
    복잡한 백엔드 애플리케이션과 연결하는 일을 한다.

### 서버사이드 인클루드

    리소스가 서버사이드 인클루드를 포함하고 있는 것으로 설정되어 있다면
    서버는 그 리소스의 컨텐츠를 클라이언트에게 보내기 전에 처리한다.

### 접근 제어

    리소스에 대한 요청이 도착했을 때 웹 서버는 클라이언트의 IP 주소에 근거하여
    접근을 제어할 수 있고 혹은 리소스에 접근하기 위한 비밀번호를 물어볼 수도 있다.

#

## 단계 5: 응답 만들기

### 응답 엔터티

-   응답 본문의 MIME 타입을 서술하는 Content-Type 헤더
-   응답 본문의 길이를 서술하는 Content-Length 헤더
-   실제 응답 본문의 내용

### MIME 타입 결정하기

-   mime.types: 확장자 별 MIME 타입 탐색
-   Magic typing: 파일 내용을 검사해서 알려진 패턴에 대한 테이블(매직 파일)에 해당하는 패턴을 찾는다.
-   유형 명시(Explicit typing): 특정 파일이나 특정 디렉토리 내 파일들이 확장자나 내용에 상관없이 MIME 타입을 설정한다.
-   유형 협상(Type negotiation): 리소스가 여러 종류의 문서 형식에 속하도록 하고 가장 좋은 형식을 판별한다.

### 리다이렉션

    요청을 수행하기 위해 브라우저가 다른 곳으로 가도록 리다이렉트한다.

-   영구히 리소스가 옮겨진 경우(301)
-   임시로 리소스가 옮겨진 경우(303, 307): 나중에 원래 URL로 찾아오고 북마크도 갱신하지 않는다.
-   uRL 증강: 문맥 정보를 포함시키기 위해 재 작성된 URL로 리다이렉트한다.
-   부하 균형: 과부화된 요청을 받으면 덜 부하가 걸린 서버로 리다이렉트한다.
-   친밀한 서버: 사용자에 대한 정보를 갖고 있는 서버로 리다이렉트한다.
-   디렉터리 이름 정규화: /를 빠뜨리거나 하면 추가한 URL로 리다이렉트한다.

#

## 단계 6: 응답 보내기

    비지속적인 커넥션이라면 모든 메세지를 전송했을 때 커넥션을 닫을 것이다.
    지속적인 커넥션이라면 Content-Length 헤더를 바르게 계산하기 위해 주의하는 경우나
    응답이 클라이언트가 응답이 언제 끝나는지 알 수 없을 경우 열린 상태를 유지할 것이다.

#

## 단계 7: 로깅

    트랜잭션이 완료되었을 때 트랜잭션이 어떻게 수행되었는지 로그를 로그 파일에 기록한다.
